# node-installation Specification

## Purpose
TBD - created by archiving change implement-edge-node-management-mvp. Update Purpose after archive.
## Requirements
### Requirement: 根据节点状态动态生成 iPXE 引导脚本

The system SHALL dynamically generate iPXE boot scripts based on node status.

The iPXE script behavior SHALL:
1. **Status=discovered**: Return wait loop script (sleep + chain to self) until installation is triggered
2. **Status=installing**: Return installation script (kernel/initrd from USTC mirror + preseed URL)
3. **Status=installed**: Return local boot script (exit from iPXE to local disk)

#### Scenario: Status=discovered 时返回等待循环脚本

**Given** 节点（MAC: AABBCCDDEEFF）状态为 "discovered"
**When** 节点请求 `/boot/aabbccddeeff/boot.ipxe`
**Then** 系统应当返回等待循环脚本：
```ipxe
#!ipxe
set node_url http://${server}:8080
set mac aabbccddeeff

:loop
echo Node in discovered state, waiting for installation trigger...
sleep 90
chain ${node_url}/boot/${mac}/boot.ipxe || goto loop
```

#### Scenario: Status=installing 时返回安装脚本

**Given** 节点（MAC: AABBCCDDEEFF）状态为 "installing"
**When** 节点请求 `/boot/aabbccddeeff/boot.ipxe`
**Then** 系统应当返回安装脚本：
```ipxe
#!ipxe
set node_url http://${server}:8080
set mac aabbccddeeff
set arch ${buildarch}

kernel https://mirrors.ustc.edu.cn/debian/dists/bookworm/main/installer-${arch}/current/images/netboot/debian-installer/${arch}/linux
initrd https://mirrors.ustc.edu.cn/debian/dists/bookworm/main/installer-${arch}/current/images/netboot/debian-installer/${arch}/initrd.gz
imgargs linux auto=true priority=critical url=${node_url}/preseed/${mac}/preseed.cfg
boot
```

#### Scenario: Status=installed 时返回本地启动脚本

**Given** 节点（MAC: AABBCCDDEEFF）状态为 "installed"
**When** 节点请求 `/boot/aabbccddeeff/boot.ipxe`
**Then** 系统应当返回本地启动脚本：
```ipxe
#!ipxe
echo Booting from local disk...
exit
```

#### Scenario: 请求不存在的节点的 iPXE 脚本

**Given** 节点（MAC: FFFFFFFF0000）不存在于数据库中
**When** 请求 `/boot/ffffffff0000/boot.ipxe`
**Then** 系统应当返回 404 Not Found

### Requirement: 动态生成 preseed 配置文件

The system SHALL dynamically generate preseed configuration files for each node.

The preseed configuration SHALL:
1. Use USTC mirror as package source
2. Complete installation automatically without user interaction
3. Install and configure NodeFoundry agent via late_command
4. Configure agent as systemd service

#### Scenario: 请求节点的 preseed 配置文件

**Given** 节点（MAC: AABBCCDDEEFF）已存在于数据库中
**When** 请求 `/preseed/aabbccddeeff/preseed.cfg`
**Then** 系统应当返回有效的 preseed 配置，包含：
```bash
d-i debian-installer/locale string en_US
d-i keyboard-configuration/xkb-keymap select us
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string node-aabbccddeeff
d-i mirror/country string manual
d-i mirror/http/hostname string mirrors.ustc.edu.cn
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i time/zone string Asia/Shanghai
d-i clock-setup/utc-auto boolean true
d-i clock-setup/utc boolean true
d-i partman-auto/method string regular
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i pkgsel/upgrade select none
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string default
d-i finish-install/reboot_in_progress note

# Install NodeFoundry agent
d-i preseed/late_command string in-target /bin/sh -c "apt-get install -y curl mosquitto-clients; curl -fsSL http://${server}:8080/agent/nodefoundry-agent -o /usr/local/bin/nodefoundry-agent; chmod +x /usr/local/bin/nodefoundry-agent; curl -fsSL http://${server}:8080/agent/nodefoundry-agent.service -o /etc/systemd/system/nodefoundry-agent.service; systemctl enable nodefoundry-agent.service"
```

### Requirement: API 触发节点安装

The system SHALL support triggering node installation via RESTful API by administrators.

Administrators SHALL be able to trigger installation only for nodes with "discovered" status.

Preseed configuration SHALL be dynamically generated by the system at `/preseed/:mac/preseed.cfg`.

#### Scenario: 触发新节点安装

**Given** 节点（MAC: AABBCCDDEEFF）状态为 "discovered"
**When** 管理员发送 PUT 请求到 `/api/v1/nodes/aabbccddeeff`，请求体：
```json
{
  "action": "install"
}
```
**Then** 系统应当：
- 将节点状态更新为 "installing"
- 返回 200 OK 和更新后的节点信息
- 节点的 iPXE 循环将在下次重试时获取到安装脚本
- 安装脚本将指向 `/preseed/aabbccddeeff/preseed.cfg`

#### Scenario: 触发安装时状态不正确（非 discovered）

**Given** 节点状态为 "installing" 或 "installed"
**When** 管理员请求触发安装
**Then** 系统应当返回 400 Bad Request，错误信息：
```json
{
  "error": "cannot install node with status 'installing', only 'discovered' nodes can be installed"
}
```

### Requirement: 提供 Agent 下载端点

The system SHALL provide HTTP endpoints for agent binary and systemd service file download.

#### Scenario: 下载 agent 二进制文件

**Given** 系统正在运行
**When** 请求 `/agent/nodefoundry-agent`
**Then** 系统应当返回 agent 二进制文件，Content-Type: `application/octet-stream`

#### Scenario: 下载 systemd 服务文件

**Given** 系统正在运行
**When** 请求 `/agent/nodefoundry-agent.service`
**Then** 系统应当返回 systemd 服务文件内容，Content-Type: `text/plain`

---

